<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages Box</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background-color: #f5f5f5;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .sidebar {
      width: 20%;
      height: 100%;
      float: left;
      background-color: #f9f9f9;
      padding: 10px;
      box-sizing: border-box;
    }

    .sidebar-toggle {
      display: none;
    }

    .sidebar h3 {
      margin: 10px 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      margin: 5px 0;
      cursor: pointer;
    }

    .content {
      width: 75%;
      float: right;
      padding: 20px;
      box-sizing: border-box;
    }

    .clear {
      clear: both;
    }

    .container {
      width: 100%;
      height: 100vh;
    }

    footer {
      bottom: 0;
      text-align: center;
      font-size: 10px;
      background-color: #333;
      color: white;
      padding: 10px;
    }

    .content {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    .clear {
      clear: both;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      z-index: 1;
      margin-top: 5px;
    }

    .dropdown-content a {
      color: black;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
      font-size: 14px;
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .dropdown-content.active {
      display: block;
    }

    .dropdown-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    #dropdownNotificationButton {
      cursor: pointer;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .notification-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dropdown-content {
      position: absolute;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .notification-dropdown-content {
      position: absolute;
      bottom: 50px;
      right: 0;
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: none;
      border-radius: 5px;
      z-index: 1;
      margin-top: 5px;

    }

    .notification-dropdown-content a {
      color: black;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
      font-size: 14px;
    }

    .notification-dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .notification-dropdown-content.active {
      display: block;
    }

    .notification {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    .notification img {
      width: 15px;
      height: 15px;
    }

    .notification p {
      margin: 0;
    }

    #message-list {
      max-width: 1000px;
      margin: 20px auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }

    .message {
      padding: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    .message:last-child {
      border-bottom: none;
    }

    #paginationControls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding-top: 20px;
      width: 100%;
      text-align: center;
    }


    @media screen and (max-width: 800px) {
      body {
        flex-direction: column;
        display: flex;
      }

      header {
        padding: 10px;
      }

      footer {
        width: 100%;
        margin-top: auto;
      }

      .sidebar {
        width: 100%;
        display: none;
        position: absolute;
        top: 26%;
        left: 0;
        background-color: #f9f9f9;
        z-index: 9999;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .sidebar-toggle {
        display: block;
        padding: 10px;
        background-color: #f5f5f5;
        text-align: left;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
      }

      .sidebar.active {
        display: block;
        height: 450px;
      }

      .content {
        width: 100%;
        padding: 10px;
        flex-grow: 1;
      }
    }
  </style>
</head>

<body>
  <header>
    <div>
      <a href="index_Login.html">
        <img src="img/logo.png" width="100px" alt="Share&Talk Logo" />
      </a>
    </div>
    <div class="dropdown-notification">
      <button id="dropdownNotificationButton">Notifications</button>
      <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
      <div class="notification-dropdown-content" id="dropdownNotificationContent"></div>
    </div>
    <div>
      <div class="dropdown">
        <button id="dropdownButton" style="margin-right: 20px">
          <img src="img/person-fill.svg" width="15px" alt="Account Icon" /> My Account
        </button>
        <div class="dropdown-content" id="dropdownContent">

          <a href="AccountDetail.html">Account Detail</a>
          <a href="PsychologicalResult.html">Psychological Test Record</a>
        </div>
      </div>
      <button>
        <a href="login.html"><img src="IMG/box-arrow-right.svg" width="15px" /> Logout</a>
      </button>
    </div>
  </header>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    let userID = null;

    async function fetchUserData() {
      const response = await fetch("/api/userData");
      if (response.ok) {
        const userData = await response.json();
        userID = userData.userID;
        document.getElementById("dropdownButton").innerHTML = `
       <img src="img/person-fill.svg" width="15px" alt="Account Icon"> My Account
    `;
        updateNotificationBadge();
      } else {
        alert("Failed to fetch user data.");
        window.location.href = "/";
      }
    }

    const dropdownButton = document.getElementById('dropdownButton');
    const dropdownContent = document.getElementById('dropdownContent');
    const dropdownNotificationButton = document.getElementById("dropdownNotificationButton");
    const notificationBadge = document.getElementById("notificationBadge");
    const dropdownNotificationContent = document.getElementById("dropdownNotificationContent");

    dropdownButton.addEventListener("click", () => {
      dropdownContent.classList.toggle("active");
    });

    if (dropdownNotificationButton) {
      dropdownNotificationButton.addEventListener("click", () => {
        dropdownNotificationContent.classList.toggle("active");
      });
    }

    window.addEventListener("click", (event) => {
      if (!event.target.closest(".dropdown")) {
        dropdownContent.classList.remove("active");
      }
    });

    window.addEventListener("click", (event) => {
      if (!event.target.closest(".dropdown-notification")) {
        dropdownNotificationContent.classList.remove("active");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const logoutButton = document.getElementById("logoutButton");
      if (logoutButton) {
        logoutButton.addEventListener("click", async () => {
          const response = await fetch("/api/logout", { method: "POST" });
          if (response.ok) {
            window.location.href = "/";
          } else {
            alert("Logout failed!");
          }
        });
      }
    });

    let notificationCount = 0;
    let notifications = [];
    const socket = io();

    socket.on("receiveNotification", (data) => {
      console.log("Notification received: ", data);

      if (!notifications.some(n => n.selectionID === data.selectionID)) {
        notifications.push(data);
      }

      updateNotificationBadge();
    });

    async function fetchNotifications() {
      try {
        const response = await fetch(`/api/notifications?userID=${userID}`);
        if (!response.ok) throw new Error("Unable to get notifications.");

        const { notifications: newNotifications } = await response.json();

        notifications.length = 0;

        newNotifications.forEach(n => {
          notifications.push(n);
        });

        renderNotifications();
      } catch (error) {
        console.error("Error: ", error);
      }
    }

    function renderNotifications() {
      const dropdownContent = document.getElementById("dropdownNotificationContent");
      const notificationBadge = document.getElementById("notificationBadge");

      dropdownContent.innerHTML = "";

      let unreadCount = 0;

      notifications.forEach(notification => {
        if (notification.is_read === 0) {
          unreadCount++;
        }

        const notificationDiv = document.createElement("div");
        notificationDiv.classList.add("notification");

        const messageText = notification.message_usertostaff ? notification.message_usertostaff : "No message";

        notificationDiv.innerHTML = `
  <img src="img/person-fill.svg" width="15px" alt="Account Icon" />
  <div>
    <a href="CustomerInformationCenter.html">
      <p><strong>Message from: admin</strong></p>
      <p>${messageText}</p>
      <p><small>${notification.is_read === 0 ? "Unread" : "Read"}</small></p>
    </a>
  </div>
`;

        dropdownContent.appendChild(notificationDiv);
      });

      if (unreadCount > 0) {
        notificationBadge.style.display = "inline-block";
        notificationBadge.innerText = unreadCount;
      } else {
        notificationBadge.style.display = "none";
      }
    }

    async function updateNotificationBadge() {
      if (!notificationBadge) return;

      try {
        await fetchNotifications();

        const response = await fetch(`/api/unreadNotifications?userID=${userID}`);
        if (!response.ok) throw new Error("Error.");

        const { unreadCount } = await response.json();

        if (unreadCount > 0) {
          notificationBadge.style.display = "flex";
          notificationBadge.textContent = unreadCount;
        } else {
          notificationBadge.style.display = "none";
        }
      } catch (error) {
        console.error("Error: ", error);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchUserData();
      if (userID) {
        updateNotificationBadge();
      }
    });

    document.getElementById("dropdownNotificationButton").addEventListener("click", async () => {
      if (!userID) return;

      try {
        await fetch(`/api/markNotificationRead/${userID}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });

        notificationBadge.style.display = "none";

        clearInterval(fetchInterval);
        setTimeout(() => {
          updateNotificationBadge();
          fetchNotifications();
          fetchInterval = setInterval(fetchNotifications, 10000); 
        }, 3000);
      } catch (error) {
        console.error("Error: ", error);
      }
    });

    window.addEventListener("load", updateNotificationBadge);
    window.addEventListener("popstate", updateNotificationBadge);

    window.addEventListener("load", fetchNotifications);
    window.addEventListener("popstate", fetchNotifications);

    let fetchInterval;
    document.addEventListener("DOMContentLoaded", () => {
      clearInterval(fetchInterval);
      fetchInterval = setInterval(fetchNotifications, 10000);
    });

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("active");
    }

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
      try {
        await fetchUserData();
        if (!userID) {
          userID = getUserIDFromURL();
        }

        if (!userID) {
          alert("Can not find userID, please contact admin.");
          return;
        }
        await fetchMessages(userID);
      } catch (error) {
        console.error("Error: ", error);
      }
    }

    function getUserIDFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("userID") || null;
    }

    async function fetchUserData() {
      try {
        const response = await fetch("/api/userData");
        if (!response.ok) throw new Error("Failed to fetch user data.");

        const userData = await response.json();
        userID = userData.userID;

        document.getElementById("dropdownButton").innerHTML = `
           <img src="img/person-fill.svg" width="15px" alt="Account Icon"> My Account
        `;

        updateNotificationBadge();

        return userID;
      } catch (error) {
        alert("Failed to fetch user data. Please log in again.");
        window.location.href = "/";
      }
    }

    let messages = [];
    let currentPage = 1;
    const messagesPerPage = 5;

    async function fetchMessages(userID) {
      try {
        if (!userID) {
          document.getElementById("message-list").innerHTML = "<p>Can not find userID.</p>";
          return;
        }

        const apiUrl = `/api/user-selections?userID=${userID}`;
        const response = await fetch(apiUrl);

        if (!response.ok) {
          if (response.status === 404) {
            document.getElementById("message-list").innerHTML = "<p>Can not find any message.</p>";
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        messages = data.messages || [];

        if (messages.length === 0) {
          document.getElementById("message-list").innerHTML = "<p>No New Message.</p>";
          return;
        }

        currentPage = 1;
        renderMessages();
      } catch (error) {
        document.getElementById("message-list").innerHTML = "<p>Loading message failed. Please try again.</p>";
      }
    }

    function renderMessages() {
      const messageList = document.getElementById("message-list");
      messageList.innerHTML = "";

      const totalPages = Math.ceil(messages.length / messagesPerPage);
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * messagesPerPage;
      const end = start + messagesPerPage;
      const messagesToShow = messages.slice(start, end);

      messagesToShow.forEach((message) => {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";

        let savedChoice = getCookie(`contentback_${message.userID}_${message.selectionID}`);

        let selectedText = savedChoice
          ? `<p><strong>Selected: </strong>${savedChoice}</p>`
          : `
               <div class="button-group">
                    <button onclick="NeedToHelp('${message.userID}', '${message.selectionID}', 'Yes, Use Whatsapp only', this)">Yes, Use Whatsapp only</button>
                    <button onclick="NeedToHelp('${message.userID}', '${message.selectionID}', 'Yes, Use Whatsapp and Phone', this)">Yes, Use Whatsapp and Phone</button>
                    <button onclick="NeedToHelp('${message.userID}', '${message.selectionID}', 'No', this)">No</button>
                </div>`;

        messageDiv.innerHTML = `
            <p><strong>Message:</strong> ${message.message_usertostaff}</p>
            ${selectedText}
        `;

        messageList.appendChild(messageDiv);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const totalPages = Math.ceil(messages.length / messagesPerPage) || 1;
      document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;

      document.getElementById("prevPage").disabled = currentPage === 1;
      document.getElementById("nextPage").disabled = currentPage === totalPages;
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderMessages();
        }
      });

      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(messages.length / messagesPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderMessages();
        }
      });
    });

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchUserData();
      if (userID) {
        fetchMessages(userID);
      }
    });

    function setCookie(name, value, days = 365) {
      const d = new Date();
      d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`;
    }

    function getCookie(name) {
      const cookies = document.cookie.split("; ");
      for (let i = 0; i < cookies.length; i++) {
        const [cookieName, cookieValue] = cookies[i].split("=");
        if (cookieName === name) {
          return decodeURIComponent(cookieValue);
        }
      }
      return null;
    }

    async function NeedToHelp(userID, selectionID, contentback, buttonElement) {
      const parsedUserID = Number(userID);
      const parsedSelectionID = Number(selectionID);

      if (isNaN(parsedUserID) || isNaN(parsedSelectionID) || !contentback) {
        alert("Error.");
        return;
      }

      try {
        const response = await fetch("/api/updatemessages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userID: parsedUserID,
            selectionID: parsedSelectionID,
            contentback
          }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        alert("Thank You For Your Reply. We Will Get Back You Soon.");

        setCookie(`contentback_${userID}_${selectionID}`, contentback);

        const parentDiv = buttonElement.closest(".message");
        if (parentDiv) {
          const messageText = parentDiv.querySelector("p")?.innerHTML || "Message not found";

          parentDiv.innerHTML = `
                <p>${messageText}</p>
                <p><strong>Selected: </strong>${contentback}</p>
            `;
        }
      } catch (error) {
        alert("Update failed. Please try again.");
      }
    }

  </script>

  <div class="container">
    <div class="content">
      <h1 style="text-align: center;">Message Box</h1>
      <div id="message-list">
        <p><strong>Message:</strong></p>
        <div class="message"></div>
      </div>
    </div>

    <div id="paginationControls">
      <button id="prevPage" disabled>
        < </button>
          <span id="pageInfo">Page 1</span>
          <button id="nextPage">></button>
    </div>
  </div>

  <div class="clear"></div>

</body>
</html>