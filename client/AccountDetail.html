<html>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Account Detail</title>
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    background-color: #f5f5f5;
  }

  a {
    text-decoration: none;
    color: inherit;
  }

  .menu a {
    text-decoration: none;
    color: #333;
  }

  .menu-toggle {
    display: none;
    font-size: 24px;
    cursor: pointer;
  }

  .menu {
    display: flex !important;
    flex-direction: row;
    position: static;
    box-shadow: none;
  }

  .menu li {
    margin-left: 15px;
    text-align: left;
  }
  
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    z-index: 1;
    margin-top: 5px;
  }

  .dropdown-content a {
    color: black;
    padding: 10px 15px;
    text-decoration: none;
    display: block;
    font-size: 14px;
  }

  .dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .dropdown-content.active {
    display: block;
  }

  .dropdown-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  #dropdownNotificationButton {
      cursor: pointer;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 50px;
      padding: 10px;
      width:70px;
      height:70px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      position: relative;
    }

  .notification-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: red;
    color: white;
    font-size: 12px;
    font-weight: bold;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .dropdown-content {
    position: absolute;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    padding: 10px;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    display: none;
  }

  .notification-dropdown-content {
    position: absolute;
    bottom: 50px;
    right: 0;
    background-color: white;
    border: 1px solid #ccc;
    padding: 10px;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    display: none;
    border-radius: 5px;
    z-index: 1;
    margin-top: 5px;

  }

  .notification-dropdown-content a {
    color: black;
    padding: 10px 15px;
    text-decoration: none;
    display: block;
    font-size: 14px;
  }

  .notification-dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .notification-dropdown-content.active {
    display: block;
  }

  .notification {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  .notification img {
    width: 15px;
    height: 15px;
  }

  .notification p {
    margin: 0;
  }

  .container {
    width: 100%;
    height: 100vh;
  }

  .content {
    max-width: 800px;
    margin: 50px auto;
    padding: 20px;
    background-color: #f4f4f4;
    border-radius: 5px;
  }

  label {
    display: block;
    margin: 10px 0 5px;
  }

  input[type="text"],
  input[type="password"] {
    width: calc(100% - 20px);
    padding: 8px;
    background-color: white;
    color: black;
    margin-bottom: 20px;
  }

  .address-inputs input[type="text"] {
    width: calc(50% - 12px);
    margin-right: 24px;
  }

  .address-inputs {
    display: flex;
    justify-content: space-between;
  }

  .button {
    display: block;
    width: 100%;
    padding: 10px;
    margin-top: 20px;
    background-color: red;
    color: white;
    text-align: center;
    text-decoration: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .separator {
    border-bottom: 2px solid black;
    margin: 20px 0;
  }

  .save-button {
    background-color: #333;
    color: #fff;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    border-radius: 5px;
  }

  .save-button:hover {
    background-color: #585858;
  }

  input:disabled {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
    border: 1px solid #ced4da;
  }

  #userAvatar {
  display: block;
  margin: 0 auto;
  margin-top: 10px;
}

#uploadButton {
  display: block;
  margin: 0 auto;
  margin-top: 10px;
  background-color: #f6917d;
  color:white;
  padding:10px;
  border-radius: 5px;
  border: none;
}

#uploadButton:hover {
  background-color: #ff775b;
}

.user-section {
      display: flex;
      align-items: center;
    }

  @media (max-width: 800px) {
    body {
      flex-direction: column;
      display: flex;
    }

    header {
      padding: 10px;
    }

    .menu-toggle {
      display: block;
    }

    .menu {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 60px;
      right: 0;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .menu li {
      margin: 10px 0;
      text-align: center;
    }

    .content {
    width:90%;
  }

  }
</style>
<header>
  <div>
    <a href="index_Login.html"><img src="img/logo.png" width="100px" alt="Share&Talk Logo" /></a>
  </div>
  <div class="dropdown-notification">
    <button id="dropdownNotificationButton"><img src="../client/img/notification.png" alt="Notification" width="28" height="28"></button>
    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
    <div class="notification-dropdown-content" id="dropdownNotificationContent"></div>
  </div>

<div class="user-section">
    <img id="userAvataricon" width="30px" height="30px" style="border-radius: 50%;" alt="Avatar">
  <div>
    <div class="dropdown">
      <button id="dropdownButton" style="margin-right: 20px; margin-left: 10px;">
        <img src="img/person-fill.svg" width="15px" alt="Account Icon" /> My Account
      </button>
      <div class="dropdown-content" id="dropdownContent">

        <a href="AccountDetail.html">Account Detail</a>
        <a href="PsychologicalResult.html">Psychological Test Record</a>
      </div>
    </div>
    <button id="logoutButton">
      <img src="img/box-arrow-right.svg" width="15px" /> Logout
    </button>
  </div>
</div>
</header>

<script src="/socket.io/socket.io.js"></script>

<script>
  let userID = null;
  let userAvatarURL = "img/chatroom_icon.jpg";
  async function fetchUserData() {
    const response = await fetch("/api/userData");
    if (response.ok) {
      const userData = await response.json();
      userID = userData.userID;

      userAvatarURL = userData.avatar ? `/api/avatar/${userID}` : "img/chatroom_icon.jpg";
      document.getElementById("userAvatar").src = userAvatarURL;

      userAvatarURL = userData.avatar ? `/api/avatar/${userID}` : "img/chatroom_icon.jpg";
      document.getElementById("userAvataricon").src = userAvatarURL;

      document.getElementById("dropdownButton").innerHTML = `
       <img src="img/person-fill.svg" width="15px" alt="Account Icon"> My Account
    `;

      console.log("Fatch userID:", userID);
      updateNotificationBadge();
    } else {
      alert("Failed to fetch user data. Please log in again.");
      console.error("Failed to fetch user:", error);
      window.location.href = "/";
    }
  }



  const dropdownButton = document.getElementById('dropdownButton');
  const dropdownContent = document.getElementById('dropdownContent');
  const dropdownNotificationButton = document.getElementById("dropdownNotificationButton");
  const notificationBadge = document.getElementById("notificationBadge");
  const dropdownNotificationContent = document.getElementById("dropdownNotificationContent");

  dropdownButton.addEventListener("click", () => {
    dropdownContent.classList.toggle("active");
  });

  if (dropdownNotificationButton) {
    dropdownNotificationButton.addEventListener("click", () => {
      dropdownNotificationContent.classList.toggle("active");
    });
  }

  window.addEventListener("click", (event) => {
    if (!event.target.closest(".dropdown")) {
      dropdownContent.classList.remove("active");
    }
  });

  window.addEventListener("click", (event) => {
    if (!event.target.closest(".dropdown-notification")) {
      dropdownNotificationContent.classList.remove("active");
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    const logoutButton = document.getElementById("logoutButton");
    if (logoutButton) {
      logoutButton.addEventListener("click", async () => {
        const response = await fetch("/api/logout", { method: "POST" });
        if (response.ok) {
          window.location.href = "/";
        } else {
          alert("Logout failed!");
        }
      });
    }
  });

  let notificationCount = 0;
  let notifications = [];
  const socket = io();

  socket.on("receiveNotification", (data) => {
    if (!notifications.some(n => n.selectionID === data.selectionID)) {
      notifications.push(data);
    }

    updateNotificationBadge();
  });

  async function fetchNotifications() {
    try {
      const response = await fetch(`/api/notifications?userID=${userID}`);
      if (!response.ok) throw new Error("Failed to fetch notification.");

      const { notifications: newNotifications } = await response.json();

      notifications.length = 0;

      newNotifications.forEach(n => {
        notifications.push(n);
      });

      renderNotifications();
    } catch (error) {
      console.error("Failed to fetch notification:", error);
    }
  }

  function renderNotifications() {
    const dropdownContent = document.getElementById("dropdownNotificationContent");
    const notificationBadge = document.getElementById("notificationBadge");

    dropdownContent.innerHTML = "";

    let unreadCount = 0;

    notifications.forEach(notification => {
      if (notification.is_read === 0) {
        unreadCount++;
      }

      const notificationDiv = document.createElement("div");
      notificationDiv.classList.add("notification");

      const messageText = notification.message_usertostaff ? notification.message_usertostaff : "No message";

      notificationDiv.innerHTML = `
  <img src="img/person-fill.svg" width="15px" alt="Account Icon" />
  <div>
    <a href="CustomerInformationCenter.html">
      <p><strong>Message From: Admin</strong></p>
      <p>${messageText}</p>
      <p><small>${notification.is_read === 0 ? "Unread" : "Read"}</small></p>
    </a>
  </div>
`;

      dropdownContent.appendChild(notificationDiv);
    });

    if (unreadCount > 0) {
      notificationBadge.style.display = "inline-block";
      notificationBadge.innerText = unreadCount;
    } else {
      notificationBadge.style.display = "none";
    }
  }

  async function updateNotificationBadge() {
    if (!notificationBadge) return;

    try {
      await fetchNotifications();

      const response = await fetch(`/api/unreadNotifications?userID=${userID}`);
      if (!response.ok) throw new Error("Failed to fetch notification.");

      const { unreadCount } = await response.json();
      console.log("Error: ", unreadCount);

      if (unreadCount > 0) {
        notificationBadge.style.display = "flex";
        notificationBadge.textContent = unreadCount;
      } else {
        notificationBadge.style.display = "none";
      }
    } catch (error) {
      console.error("Error: ", error);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await fetchUserData();
    if (userID) {
      updateNotificationBadge();
    }
  });


  document.getElementById("dropdownNotificationButton").addEventListener("click", async () => {
    if (!userID) return;

    try {
      await fetch(`/api/markNotificationRead/${userID}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      notificationBadge.style.display = "none";

      clearInterval(fetchInterval);
      setTimeout(() => {
        updateNotificationBadge();
        fetchNotifications();
        fetchInterval = setInterval(fetchNotifications, 10000);
      }, 3000);
    } catch (error) {
      console.error("Error: ", error);
    }
  });

  window.addEventListener("load", updateNotificationBadge);
  window.addEventListener("popstate", updateNotificationBadge);

  window.addEventListener("load", fetchNotifications);
  window.addEventListener("popstate", fetchNotifications);

  let fetchInterval;
  document.addEventListener("DOMContentLoaded", () => {
    clearInterval(fetchInterval);
    fetchInterval = setInterval(fetchNotifications, 10000);
  });

  socket.onmessage = function (event) {
    const message = event.data;
    const dropdownContent = document.getElementById('dropdownContent');
    const notification = document.createElement('a');
    notification.href = "#";
    notification.innerText = message;
    dropdownContent.appendChild(notification);
  };

</script>

<body>
  <div class="container">
    <div class="content">
      
      <img id="userAvatar" width="100px" height="100px" style="border-radius: 50%;" alt="Avatar" onclick="document.getElementById('avatarInput').click();">
<input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewImage(event)">
<button id="uploadButton" onclick="uploadAvatar()">Upload</button>

  
      <h3>Login Account</h3>
      
      <input type="text" id="email" disabled />

      <div class="separator"></div>

      <h2>Account Information</h2>

      <label for="contact">Name</label>
      <input type="text" id="fullName" disabled />

      <label for="contact">Phone</label>
      <input type="text" id="phone" disabled />

      <label>Address</label>
      <div class="address-inputs">
        <input type="text" placeholder="Room" id="room" />
        <input type="text" placeholder="Floor" id="floor" />
      </div>
      <input type="text" placeholder="Estate" id="estate" />
      <input type="text" placeholder="Street" id="street" />
      <button type="button" class="save-button" onclick="updateAddress()">
        Save
      </button>

      <div class="separator"></div>

      <h2>Edit Password</h2>
      <label for="current-password">Current Password</label>
      <input type="password" id="current-password" />

      <label for="new-password">New Password</label>
      <input type="password" id="new-password" />

      <label for="reenter-password">Re-Enter New Password</label>
      <input type="password" id="reenter-password" />
      <p style="font-size: 12px; margin-top:-10px; margin-bottom:30px;">*Note: At least 8 characters, 1 uppercase letter, 1 lowercase letter and 1 number.</p>

      <button class="save-button" onclick="updatePassword()">Save</button>
    </div>
  </div>

  <div class="clear"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/api/userData")
        .then((response) => {
          if (!response.ok) {
            throw new Error("User not logged in");
          }
          return response.json();
        })
        .then((user) => {
          console.log(user);

          const emailField = document.querySelector("#email");
          const phoneField = document.querySelector("#phone");
          const roomField = document.querySelector("#room");
          const floorField = document.querySelector("#floor");
          const estateField = document.querySelector("#estate");
          const streetField = document.querySelector("#street");
          const fullNameField = document.querySelector("#fullName");

          if (emailField)
            emailField.value = user.email || "No email provided";
          if (phoneField)
            phoneField.value = user.phone || "No phone number provided";
          if (fullNameField)
            fullNameField.value = user.username || "No name provided";

          if (roomField) roomField.value = user.room || "";
          if (floorField) floorField.value = user.floor || "";
          if (estateField) estateField.value = user.estate || "";
          if (streetField) streetField.value = user.street || "";
        })
        .catch((error) => {
          alert("Error fetching user data: " + error.message);
        });
    });

    function updateAddress() {
      const room = document.getElementById("room").value;
      const floor = document.getElementById("floor").value;
      const estate = document.getElementById("estate").value;
      const street = document.getElementById("street").value;

      fetch("/api/updateAddress", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ room, floor, estate, street }),
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
        })
        .catch((error) => {
          console.error("Error updating address:", error);
        });
    }

    function updatePassword() {
      const currentPassword =
        document.getElementById("current-password").value;
      const newPassword = document.getElementById("new-password").value;
      const reenterPassword =
        document.getElementById("reenter-password").value;

      fetch("/api/updatePassword", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          currentPassword,
          newPassword,
          reenterPassword,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    }

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('userAvatar').src = e.target.result;
            document.getElementById('userAvataricon').src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
}

let isUploaded = false; 

async function uploadAvatar() {
        const fileInput = document.getElementById("avatarInput");
        const file = fileInput.files[0];

        if (!file ) {
          alert("Please select new image");
          return;
        }

        if (!isUploaded && file) {
          isUploaded = false;
  }

        if (isUploaded) {
          alert("Please select new image");
        return;
    }

        const formData = new FormData();
        formData.append("avatar", file);
        formData.append("userID", userID);

        try {
          const response = await fetch("/api/updateAvatar", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          isUploaded = true;
          alert("Uloaded successful");

          if (response.ok) {
            document.getElementById(
              "profileAvatar"
            ).src = `/api/avatar/${userID}?t=${new Date().getTime()}`;
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }
      document.getElementById("avatarInput").addEventListener("change", () => {
        isUploaded = false;
      });

  </script>

</body>
</html>