<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="/socket.io/socket.io.js"></script>
  <title>Chatroom Messages Management</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background-color: #f5f5f5;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .content,
    .content2 {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
    }

    .search-bar {
      margin-top: 20px;
      text-align: center;
    }

    .search-bar input {
      width: 50%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    @media screen and (max-width: 800px) {
      body {
        flex-direction: column;
        display: flex;
      }

      .content,
      .content2 {
        width: 100%;
        padding: 10px;
      }
    }

    .message-bubble {
      display: inline-block;
      background-color: #f0f0f0;
      padding: 10px 15px;
      border-radius: 5px;
      max-width: 80%;
      word-wrap: break-word;
      margin: 5px 0;
      font-size: 14px;
    }

    .message-bubble.sensitive {
      background-color: #f8d7da;
      color: #721c24;
      font-weight: bold;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      z-index: 1;
      margin-top: 5px;
    }

    .dropdown-content a {
      color: black;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
      font-size: 14px;
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .dropdown-content.active {
      display: block;
    }


    td {
      text-align: center;
      padding: 20px;
    }

    #usersResult-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    #usersResult-table th,
    #usersResult-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    #usersResult-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .quiz-results,
    .recommendations {
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .no-recommendations {
      color: #888;
      font-style: italic;
    }

    .recommendation-column {
      max-width: 300px;
      word-wrap: break-word;
    }

    #paginationControls {
      display: flex;
      gap: 10px;
      width: 100%;
      text-align: center;
      padding-top: 20px;
      justify-content: center; 
    }
  </style>
</head>

<body>
  <header>
    <div>
      <a href="ClientPsychologicalResult.html"><img src="img/logo.png" width="100px" alt="Share&Talk Logo" /></a>
    </div>
    <div>
      <div class="dropdown">
        <button id="dropdownButton" style="margin-right: 20px; margin-left: 20px;">
          <img src="img/person-fill.svg" width="15px" alt="Account Icon" />
          Manage
        </button>
        <div class="dropdown-content" id="dropdownContent">
          <a href="StaffDashboard.html">Dashboard</a>
          <a href="StaffAccountDetail.html">Accounts</a>
          <a href="ClientManage.html">User Manage</a>
          <a href="ClientPsychologicalResult.html">Psychological Test Result</a> <a
            href="ChatroomMessagesaManage.html">Chatroom Messages</a>

        </div>
      </div>
      <button id="logoutButton"><img src="img/box-arrow-right.svg" width="15px" /> Logout</a>
      </button>
    </div>
  </header>
  <script>
    const dropdownButton = document.getElementById("dropdownButton");
    const dropdownContent = document.getElementById("dropdownContent");

    dropdownButton.addEventListener("click", () => {
      dropdownContent.classList.toggle("active");
    });

    window.addEventListener("click", (event) => {
      if (!event.target.closest(".dropdown")) {
        dropdownContent.classList.remove("active");
      }
    });

    function resultInput() {
      const input = document.getElementById("resultInput");
      const filter = input.value.toUpperCase();
      const tbody = document.getElementById("usersResult-table");
      const rows = tbody.getElementsByTagName("tr");

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let match = false;

        for (let j = 0; j < cells.length; j++) {
          const txtValue = cells[j].textContent || cells[j].innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            match = true;
            break;
          }
        }

        rows[i].style.display = match ? "" : "none";
      }
    } function onDateChoose() {
      const select = document.getElementById("DateChoose");
      const selectedDate = select.value; 
      const tbody = document.getElementById("usersResult-table");
      const rows = tbody.getElementsByTagName("tr");

      console.log(`Selected Date: ${selectedDate}`);

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        const dateCell = cells[2];

        if (dateCell) {
          const messageDate = formatDate(dateCell.textContent); 
          const messageDateOnly = messageDate.split(" ")[0]; 

          if (selectedDate === "" || messageDateOnly === selectedDate) {
            rows[i].style.display = "";
          } else {
            rows[i].style.display = "none";
          }
        }
      }
    }

  </script>

  <center>
    <h1>Chatroom Messages Management</h1>
  </center>
  <div class="search-bar">
    <input type="text" id="resultInput" onkeyup="resultInput()" placeholder="Search..." />
    <input type="date" id="DateChoose" onchange="onDateChoose()" style="width: 150px;height: 35px; border-radius: 5px" >

  </div>

  <div class="content" onload="fetchUserResult()" onchange="changemode()">
    <table style="
          width: 100%;
          border: 1px solid #ddd;
          padding: 20px;
          margin-top: 20px;
        ">
      <thead>
        <tr>
          <th>Message ID</th>
          <th>User Id</th>
          <th>Date</th>
          <th>Message</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody id="usersResult-table">
      
      </tbody>
    </table>
    <div id="paginationControls">
      <button id="prevPage" onclick="prevPage()" disabled>&lt;</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextPage" onclick="nextPage()">&gt;</button>
    </div>
  </div>

  <div class="content2" style="display: none">
    <table style="
          width: 100%;
          border: 1px solid #000000;
          padding: 20px;
          margin-top: 20px;
        ">
      <thead>
        <tr>
          <th>Message ID</th>
          <th>User ID</th>
          <th>Date</th>
          <th>Message</th>
          <th>Address</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Need to Help?</th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody id="usersResult-table-all">
      </tbody>
    </table>
    <button onclick="changemode()" style="margin-top: 20px">Back</button>
  </div>
  <script>
    document
      .getElementById("logoutButton")
      .addEventListener("click", async () => {
        const response = await fetch("/api/logout", { method: "POST" });
        if (response.ok) {
          window.location.href = "../client/index_nonLogin.html";
        } else {
          alert("Logout failed!");
        }
      });

    let assessmentID = null;

    document.addEventListener("DOMContentLoaded", () => {
      fetchUserMessages();
    });
    function formatDate(isoDate) {
      if (!isoDate) return "N/A"; 
      const date = new Date(isoDate);

      const year = date.getFullYear();
      const month = ("0" + (date.getMonth() + 1)).slice(-2); 
      const day = ("0" + date.getDate()).slice(-2); 

      const hours = ("0" + date.getHours()).slice(-2); 
      const minutes = ("0" + date.getMinutes()).slice(-2); 
      const seconds = ("0" + date.getSeconds()).slice(-2); 

      return `${year}/${month}/${day} ${hours}:${minutes}`; 
    }

    let messagesData = []; 
    let currentPage = 1;
    const pageSize = 10; 

    async function fetchUserMessages() {
      try {
        const response = await fetch("/api/userMessages");
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const contentType = response.headers.get("Content-Type");
        if (contentType && contentType.includes("application/json")) {
          messagesData = await response.json();
          filterSensitiveMessages(); 
          displayPage(currentPage); 
        } else {
          console.error("Non-JSON response:", await response.text());
          alert("Server returned non-JSON response.");
        }
      } catch (error) {
        console.error("Failed to fetch user messages:", error);
      }
    }

    function filterSensitiveMessages() {
      const sensitiveKeywords = ["suicide", "depression", "anxiety", "mental health", "help", "die", "kill", "jump"];
      messagesData = messagesData.filter((message) =>
        sensitiveKeywords.some((keyword) => message.message.toLowerCase().includes(keyword))
      );
    }

    function displayPage(page) {
      const table = document.getElementById("usersResult-table");
      table.innerHTML = "";

      messagesData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));


      let startIndex = (page - 1) * pageSize;
      let endIndex = startIndex + pageSize;
      let pageData = messagesData.slice(startIndex, endIndex);

      if (pageData.length === 0) {
          resultTableBody.innerHTML = `<tr><td colspan="5">No Result</td></tr>`;
          paginationControls.style.display = "none";
        } else {
          paginationControls.style.display = "block";

      pageData.forEach((message) => {
        const isSensitive = ["suicide", "depression", "anxiety", "mental health", "help", "die", "kill"].some((keyword) =>
          message.message.toLowerCase().includes(keyword)
        );

        const messageContent = isSensitive
          ? `<span class="message-bubble sensitive">${message.message}</span>`
          : `<span class="message-bubble">${message.message}</span>`;

        const row = `
      <tr>
        <td>${message.messageID}</td>
        <td>${message.userID}</td>
        <td>${formatDate(message.created_at)}</td>
        <td>${messageContent}</td>
        <td><button onclick="onDetailsButtonClick(${message.messageID})">Details</button></td>
      </tr>`;
        table.innerHTML += row;
      });

      updatePaginationControls();
    }
  }

    function updatePaginationControls() {
      document.getElementById("prevPage").disabled = currentPage === 1;
      document.getElementById("nextPage").disabled = currentPage * pageSize >= messagesData.length;
      document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${Math.ceil(messagesData.length / pageSize)}`;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        displayPage(currentPage);
      }
    }

    function nextPage() {
      if (currentPage * pageSize < messagesData.length) {
        currentPage++;
        displayPage(currentPage);
      }
    }

    async function fetchUserByMessageID(messageID) {
    try {
        const response = await fetch(`/api/userAll/message/${messageID}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const results = await response.json();
        const table = document.getElementById("usersResult-table-all");
        table.innerHTML = "";

        const sensitiveKeywords = ["suicide", "depression", "anxiety", "mental health", "help", "die", "kill"];

        results.forEach((user) => {
            const isSensitive = sensitiveKeywords.some((keyword) =>
                user.message.toLowerCase().includes(keyword)
            );

            const messageContent = isSensitive
                ? `<span class="message-bubble sensitive">${user.message}</span>`
                : `<span class="message-bubble">${user.message}</span>`;

            const isSent = localStorage.getItem(`sent_${user.messageID}_${user.userID}`) === '1';

            const row = `
            <tr>
                <td>${user.messageID || "N/A"}</td>
                <td>${user.userID}</td>
                <td>${formatDate(user.dateTaken) || "N/A"}</td>
                <td>${messageContent}</td>
                <td>${user.room || ""} ${user.floor || ""} ${user.estate || ""} ${user.street || ""}</td>
                <td>${user.phone || "N/A"}</td>
                <td>${user.email || "N/A"}</td>
                <td>${user.contentback || "No reply"}</td>
                <td>
                    <button 
                        id="sendBtn-${user.messageID}-${user.userID}"
                        onclick="sendMessage(${user.userID}, '${user.messageID}')"
                        ${isSent ? 'disabled' : ''} 
                        style="${isSent ? 'background-color: #ccc; cursor: not-allowed;' : ''}">
                        ${isSent ? 'Send' : 'Send'}
                    </button>
                </td>
            </tr>`;

            table.innerHTML += row;
        });

        if (results.length === 0) {
            table.innerHTML = `<tr><td colspan="9">No data found for this message ID.</td></tr>`;
        }
    } catch (error) {
        console.error("Failed to fetch message details:", error);
    }
}

async function sendMessage(userID, messageID) {
    const button = document.getElementById(`sendBtn-${messageID}-${userID}`);

    if (button.disabled) {
        alert("You have already sent a message for this user.");
        return;
    }

    const message = prompt("Message:");
    if (!message) {
        alert("Please input message");
        return;
    }
    const messageType = 'chatroom';

    try {
        const response = await fetch(`/api/sendMessage/${userID}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ message, message_type: messageType })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed send message");
        }

        const data = await response.json();
        alert(data.message || "Message sent successfully");

        localStorage.setItem(`sent_${messageID}_${userID}`, '1');

        button.disabled = true;
        button.textContent = "Send";
        button.style.backgroundColor = "#ccc";
        button.style.cursor = "not-allowed";

    } catch (error) {
        console.error("error:", error);
        alert(error.message || "Please try again");
    }
}

    function onDetailsButtonClick(id) {
      fetchUserByMessageID(id);
      document.querySelector(".search-bar").style.display = "none";
      document.querySelector(".content").style.display = "none";
      document.querySelector(".content2").style.display = "block";
      document.getElementById("paginationControls").style.display = "none";
    }

    function changemode() {
      document.querySelector(".search-bar").style.display = "block";
      document.querySelector(".content").style.display = "block";
      document.querySelector(".content2").style.display = "none";
      document.getElementById("paginationControls").style.display = "flex";
    }
  </script>
</body>

</html>