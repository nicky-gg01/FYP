<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #f5f5f5;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .content {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .search-bar {
            margin-top: 20px;
            text-align: center;
            margin-bottom:20px;
        }

        .search-bar input {
            width: 50%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #paginationControls {
            display: flex;
            gap: 10px;
            width: 100%;
            text-align: center;
            padding-top: 20px;
            justify-content: center; 
        }

        @media screen and (max-width: 800px) {
            body {
                flex-direction: column;
                display: flex;
            }
            .content {
                width: 100%;
                padding: 10px;
            }
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            z-index: 1;
            margin-top: 5px;
        }

        .dropdown-content a {
            color: black;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content.active {
            display: block;
        }

        td {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <a href="ClientPsychologicalResult.html"><img src="img/logo.png" width="100px" alt="Share&Talk Logo" /></a>
        </div>
        <div>
            <div class="dropdown">
                <button id="dropdownButton" style="margin-right: 20px; margin-left: 20px;">
                    <img src="img/person-fill.svg" width="15px" alt="Account Icon" /> Manage
                </button>
                <div class="dropdown-content" id="dropdownContent">
                    <a href="StaffDashboard.html">Dashboard</a>
                    <a href="StaffAccountDetail.html">Accounts</a>
                    <a href="ClientManage.html">User Manage</a>
                    <a href="ClientPsychologicalResult.html">Psychological Test Result</a>
                    <a href="ChatroomMessagesaManage.html">Chatroom Messages</a>

                </div>
            </div>
            <button id="logoutButton">
                <a href="../client/index_nonLogin.html"><img src="img/box-arrow-right.svg" width="15px" /> Logout</a>
            </button>
        </div>
    </header>
    <script>
        const dropdownButton = document.getElementById("dropdownButton");
        const dropdownContent = document.getElementById("dropdownContent");

        dropdownButton.addEventListener("click", () => {
            dropdownContent.classList.toggle("active");
        });

        window.addEventListener("click", (event) => {
            if (!event.target.closest(".dropdown")) {
                dropdownContent.classList.remove("active");
            }
        });
     
        function clientInput() {
            const input = document.getElementById('clientInput');
            const filter = input.value.toUpperCase();
            const tbody = document.getElementById("users-table");
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let match = false;

                for (let j = 0; j < cells.length; j++) {
                    const txtValue = cells[j].textContent || cells[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        match = true;
                        break;
                    }
                }

                rows[i].style.display = match ? "" : "none";
            }
        }
    </script>

    <center>
        <h1>User List</h1>
    </center>

    <div class="search-bar">
        <input type="text" id="resultInput" onkeyup="resultInput()" placeholder="Search..." />
    </div>

    <div class="content" onload="fetchStaff()">
        <table style="width:100%; border: 1px solid #ddd; border-radius: 5px; padding: 20px;">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Email</th>
                    <th>User Name</th>
                    <th>Password</th>
                    <th>Phone</th>
                    <th>Room</th>
                    <th>Floor</th>
                    <th>Estate</th>
                    <th>Street</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="users-table">
     
            </tbody>
        </table>
    </div>

    <div id="paginationControls">
        <button id="prevPage" disabled><</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage">></button>
    </div>

    <script>

        document.getElementById("logoutButton").addEventListener("click", async () => {
            const response = await fetch("/api/logout", { method: "POST" });
            if (response.ok) {
                window.location.href = "stafflogin.html";
            } else {
                alert("Logout failed!");
            }
        });

       
        document.addEventListener("DOMContentLoaded", fetchUsers);

        async function fetchUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const users = await response.json();
                const table = document.getElementById('users-table');
                table.innerHTML = '';

                users.forEach(user => {
                    const row = `
            <tr>
              <td>${user.userID}</td>
              <td>${user.email}</td>
              <td>${user.username}</td>
              <td>******</td>
              <td>${user.phone}</td>
              <td>${user.room || '-'}</td>
              <td>${user.floor || '-'}</td>
              <td>${user.estate || '-'}</td>
              <td>${user.street || '-'}</td>
             <td><button onclick="deleteUsers(${user.userID})">Delete</button></td>
              <td><button onclick="updatePassword(${user.userID})">Update</button></td>
            </tr>`;
                    table.innerHTML += row;
                });
            } catch (error) {
                console.error('Failed fetch:', error);
            }
        }

   
        async function deleteUsers(userID) {
            try {
                const response = await fetch(`/api/userdelete/${userID}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed delete user');
                }

                alert('Deleted successfully');
                fetchUsers(); 
            } catch (error) {
                console.error('error:', error);
            }
        }

        async function updatePassword(userID) {
            const newPassword = prompt('Please input new password.');
            if (!newPassword) return;

            const reenterPassword = prompt('Please input new confirm password.');
            if (newPassword !== reenterPassword) {
                alert('New password not match. Please try again.');
                return;
            }

            try {
                const response = await fetch(`/api/userpassword/${userID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword, reenterPassword })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Password update failed.');
                }

                alert('Password update sucessfuly.');
                fetchUsers();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        let users = [];
let currentPage = 1;
const usersPerPage = 10;

document.addEventListener("DOMContentLoaded", fetchUsers);
document.getElementById("prevPage").addEventListener("click", () => changePage(-1));
document.getElementById("nextPage").addEventListener("click", () => changePage(1));

async function fetchUsers() {
    try {
        const response = await fetch('/api/users');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        users = await response.json();
        currentPage = 1; 
        renderUsers();
        updatePaginationControls();
    } catch (error) {
        console.error('Failed fetch:', error);
    }
}

function renderUsers() {
    const table = document.getElementById('users-table');
    const paginationControls = document.getElementById("paginationControls");
    table.innerHTML = '';

    const start = (currentPage - 1) * usersPerPage;
    const end = start + usersPerPage;
    const paginatedUsers = users.slice(start, end);

    if (paginatedUsers.length === 0) {
        table.innerHTML = `<tr><td colspan="10">No Result</td></tr>`;
        paginationControls.style.display = "none";
    } else {
        paginationControls.style.display = "block";
        paginatedUsers.forEach(user => {
            const row = `
                <tr>
                    <td>${user.userID}</td>
                    <td>${user.email}</td>
                    <td>${user.username}</td>
                    <td>******</td>
                    <td>${user.phone}</td>
                    <td>${user.room || '-'}</td>
                    <td>${user.floor || '-'}</td>
                    <td>${user.estate || '-'}</td>
                    <td>${user.street || '-'}</td>
                    <td><button onclick="deleteUsers(${user.userID})">Delete</button></td>
                    <td><button onclick="updatePassword(${user.userID})">Update</button></td>
                </tr>`;
            table.innerHTML += row;
        });
    }
}

function updatePaginationControls() {
    const totalPages = Math.ceil(users.length / usersPerPage);
    document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
    
    document.getElementById("prevPage").disabled = currentPage === 1;
    document.getElementById("nextPage").disabled = currentPage === totalPages;
}

function changePage(direction) {
    const totalPages = Math.ceil(users.length / usersPerPage);
    if ((direction === -1 && currentPage > 1) || (direction === 1 && currentPage < totalPages)) {
        currentPage += direction;
        renderUsers();
        updatePaginationControls();
    }
}

function resultInput() {
        const searchQuery = document.getElementById('resultInput').value.toLowerCase();

        if (searchQuery === '') {
        fetchUsers();
        return;
    }

        const filteredUsers = users.filter(user => {
            return (
                user.userID.toString().includes(searchQuery) ||
                user.email.toLowerCase().includes(searchQuery) ||
                user.username.toLowerCase().includes(searchQuery) ||
                user.phone.toLowerCase().includes(searchQuery) ||
                (user.room && user.room.toLowerCase().includes(searchQuery)) ||
                (user.floor && user.floor.toLowerCase().includes(searchQuery)) ||
                (user.estate && user.estate.toLowerCase().includes(searchQuery)) ||
                (user.street && user.street.toLowerCase().includes(searchQuery))
            );
        });

        users = filteredUsers;
        currentPage = 1;
        renderUsers();
        updatePaginationControls();
    }
    
    </script>
</body>

</html>