<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #f5f5f5;
        }

        a {
            text-decoration: none;
            color: inherit;
            /* 確保文字顏色繼承父元素 */
        }

        .content {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        @media screen and (max-width: 800px) {
            body {
                flex-direction: column;
                display: flex;
            }

            .content {
                width: 100%;
                padding: 10px;
            }
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* 下拉選單樣式 */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            z-index: 1;
            margin-top: 5px;
        }

        .dropdown-content a {
            color: black;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        /* 顯示下拉選單（通過添加 active 類） */
        .dropdown-content.active {
            display: block;
        }

        td {
            text-align: center;
            padding: 20px;
        }

        .search-bar {
            margin-top: 20px;
            text-align: center;
        }

        .search-bar input {
            width: 50%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <a href="StaffManagementSystem.html"><img src="img/logo.png" width="100px" alt="Share&Talk Logo" /></a>
        </div>

        <div>
            <div class="dropdown">
                <button id="dropdownButton" style="margin-right: 20px; margin-left: 20px;">
                    <img src="img/person-fill.svg" width="15px" alt="Account Icon" /> Manage
                </button>
                <div class="dropdown-content" id="dropdownContent">
                    <a href="staffsignup.html">Staff Sign up</a>
                </div>
            </div>
        </div>
    </header>
    <script>
        const dropdownButton = document.getElementById("dropdownButton");
        const dropdownContent = document.getElementById("dropdownContent");

        dropdownButton.addEventListener("click", () => {
            dropdownContent.classList.toggle("active");
        });


        window.addEventListener("click", (event) => {
            if (!event.target.closest(".dropdown")) {
                dropdownContent.classList.remove("active");
            }
        });




        // search method
        function staffInput() {
            const input = document.getElementById('staffInput');
            const filter = input.value.toUpperCase();
            const tbody = document.getElementById("staffs-table");
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let match = false;

                for (let j = 0; j < cells.length; j++) {
                    const txtValue = cells[j].textContent || cells[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        match = true;
                        break;
                    }
                }

                rows[i].style.display = match ? "" : "none";
            }
        }
    </script>

    <center>
        <h1>Staff Account</h1>
    </center>
    <div class="search-bar">
        <input type="text" id="staffInput" onkeyup="staffInput()" placeholder="Search for Staff...">
    </div>
    <div class="content" onload="fetchStaff()">

        <table style="width:100%; border: 1px solid #000000; padding: 20px; margin-top: 20px;">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Email</th>
                    <th>User Name</th>
                    <th>Password</th>
                    <th>Phone</th>
                    <th>Room</th>
                    <th>Floor</th>
                    <th>Estate</th>
                    <th>Street</th>
                    <th>Account</th>
                    <th>Password</th>
                </tr>
            </thead>
            <tbody id="staffs-table">
                <!-- 使用者資料會動態插入到這裡 -->
            </tbody>
        </table>
    </div>
    <script>


        // 在頁面加載完成後自動執行 fetchUsers
        document.addEventListener("DOMContentLoaded", fetchStaff);

        async function fetchStaff() {
            try {
                const response = await fetch('/api/staff');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const staffs = await response.json();
                const table = document.getElementById('staffs-table');
                table.innerHTML = ''; // 清空表格內容

                staffs.forEach(staff => {
                    const row = `
            <tr>
              <td>${staff.staffID}</td>
              <td>${staff.email}</td>
              <td>${staff.username}</td>
              <td>${staff.password}</td>
              <td>${staff.phone}</td>
              <td>${staff.room || '-'}</td>
              <td>${staff.floor || '-'}</td>
              <td>${staff.estate || '-'}</td>
              <td>${staff.street || '-'}</td>
             <td><button onclick="deleteStaff(${staff.staffID})">Delete</button></td>
              <td><button onclick="updatePassword(${staff.staffID})">Update</button></td>
            </tr>`;
                    table.innerHTML += row;
                });
            } catch (error) {
                console.error('無法取得使用者資料:', error);
            }
        }

        // 刪除使用者的函數
        async function deleteStaff(staffID) {
            try {
                const response = await fetch(`/api/staffdelete/${staffID}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('刪除使用者失敗');
                }

                alert('使用者已成功刪除');
                fetchStaff(); // 重新載入表格
            } catch (error) {
                console.error('刪除使用者時出現問題:', error);
            }
        }

        // 更新使用者密碼的函數
        async function updatePassword(staffID) {
            const newPassword = prompt('Please input new password.');
            if (!newPassword) return;

            const reenterPassword = prompt('Please input new confirm password.');
            if (newPassword !== reenterPassword) {
                alert('New password not match. Please try again.');
                return;
            }

            try {
                const response = await fetch(`/api/staffpassword/${staffID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword, reenterPassword })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Password update failed.');
                }

                alert('Password update sucessfuly.');
                fetchStaff();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

    </script>

</body>

</html>